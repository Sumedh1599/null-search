<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NULL Browser</title>
    <style>
        /* ---------- BROWSER LAYOUT ---------- */
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%;overflow:hidden}
        body{
            background:#000;
            color:#fff;
            font-family:Arial,Helvetica,sans-serif;
            display:flex;
            flex-direction:column;
        }

        /* ---------- NAVIGATION BAR (hidden on home) ---------- */
        .nav-bar{
            display:flex;
            align-items:center;
            padding:8px 12px;
            background:#111;
            border-bottom:1px solid #222;
            gap:12px;
            display:none;   /* ← only shown on results/proxy tabs */
        }
        .nav-controls{display:flex;gap:4px}
        .nav-btn{
            padding:6px 12px;
            border:1px solid #333;
            background:#222;
            color:#fff;
            border-radius:4px;
            cursor:pointer;
        }
        .nav-btn:hover{background:#333}
        .nav-btn:disabled{opacity:.5;cursor:not-allowed}
        .nav-logo{font-size:25px;font-weight:bold;letter-spacing:-1px;margin:0 12px}
        .nav-search-container{display:flex;gap:8px;flex:1}
        .nav-search-input{
            flex:1;
            padding:8px 12px;
            border:1px solid #333;
            border-radius:4px;
            font-size:14px;
            background:#000;
            color:#fff;
            outline:none;
            min-width:0;
        }
        .nav-search-input:focus{border-color:#8ab4f8}
        .nav-search-btn{
            padding:8px 16px;
            background:#303134;
            color:#fff;
            border:none;
            border-radius:4px;
            cursor:pointer;
        }
        .nav-search-btn:hover{background:#3c4043}

        /* ---------- TAB BAR (hidden on home) ---------- */
        .tab-bar{
            display:flex;
            align-items:center;
            background:#111;
            border-bottom:1px solid #222;
            padding:4px 8px;
            gap:4px;
            display:none;   /* ← only shown on results/proxy tabs */
        }
        .tabs{display:flex;flex:1;gap:2px;overflow-x:auto}
        .tab{
            display:flex;
            align-items:center;
            padding:8px 16px;
            background:#222;
            border:1px solid #333;
            border-radius:4px 4px 0 0;
            cursor:pointer;
            max-width:200px;
            min-width:120px;
            white-space:nowrap;
        }
        .tab.active{background:#000;border-bottom:1px solid #000}
        .tab span{flex:1;overflow:hidden;text-overflow:ellipsis;color:#fff}
        .close-tab{margin-left:8px;background:none;border:none;cursor:pointer;font-size:16px;color:#666}
        .close-tab:hover{color:#fff}
        .new-tab-btn{padding:8px 12px;background:none;border:1px solid #333;border-radius:4px;cursor:pointer;font-size:16px;color:#fff}
        .new-tab-btn:hover{background:#222}

        /* ---------- CONTENT AREA ---------- */
        .content-area{flex:1;position:relative}
        .tab-content{display:none;width:100%;height:100%}
        .tab-content.active{display:block}
        iframe{width:100%;height:100%;border:none;background:#fff}

        /* ---------- HOME PAGE (only logo + search) ---------- */
        .home-page{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;background:#000;text-align:center}
        .home-logo{font-size:125px;font-weight:bold;letter-spacing:-1px;margin-bottom:30px;display:flex;align-items:center;gap:.04em}
        /* ---- U-to-0 loader ---- */
        .loader-container{position:relative;width:200px;height:200px;transform:scale(.625);transform-origin:center}
        .u-bottom{position:absolute;width:170px;height:100%;border:15px solid white;border-radius:0 0 85px 85px;border-top:none;box-sizing:border-box;left:15px}
        .u-top{position:absolute;width:232px;height:102%;border-top:15px solid white;border-radius:116px 116px 0 0;border-left:15px solid transparent;border-right:15px solid transparent;border-bottom:none;box-sizing:border-box;transform:rotate(180deg);left:-16px;top:-1px;animation:flipU 5s infinite}
        .diagonal-line{position:absolute;width:180px;height:15px;background-color:white;top:50%;left:50%;transform:translate(-50%,-50%) rotate(45deg);opacity:0;animation:lineAppear 5s infinite}
        @keyframes flipU{0%,40%{transform:rotate(180deg) translateY(0);opacity:0}50%,90%{transform:rotate(0) translateY(-34px);opacity:1}100%{transform:rotate(180deg) translateY(0);opacity:0}}
        @keyframes lineAppear{0%,45%{opacity:0}50%,90%{opacity:1}95%,100%{opacity:0}}

        .home-search-container{display:flex;flex-direction:column;align-items:center;gap:12px}
        .home-search-input{width:900px;padding:12px 16px;border:1px solid #5f6368;border-radius:50px;background:#000;color:#fff;outline:none;font-size:16px;text-align:center}
        .home-search-input:focus{border-color:#8ab4f8;width:840px;transition:width .2s ease}
        .home-search-btn{padding:10px 30px;background:#303134;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px}
        .home-search-btn:hover{background:#3c4043}

        /* ---------- RESULTS PAGE (with scrollbar) ---------- */
        .results-page{background:#000;color:#fff;height:100%;display:flex;flex-direction:column}
        /* 强制显示滚动条  */
        .results-content{flex:1 1 auto;overflow-y:scroll;padding:20px;scrollbar-width:thin;scrollbar-color:#444 #111}
        .results-content::-webkit-scrollbar{width:6px}
        .results-content::-webkit-scrollbar-track{background:#111}
        .results-content::-webkit-scrollbar-thumb{background:#444;border-radius:3px}
        .results-content::-webkit-scrollbar-thumb:hover{background:#555}

        .stats{color:#9aa0a6;font-size:14px;margin-bottom:20px;padding:0 10px}
        .result-item{background:#111;border-radius:8px;padding:20px;margin-bottom:16px;cursor:pointer;transition:background .2s;border:1px solid #222}
        .result-item:hover{background:#1a1a1a;border-color:#333}
        .result-header{display:flex;align-items:center;margin-bottom:8px}
        .favicon{width:16px;height:16px;margin-right:8px;border-radius:2px}
        .domain{color:#8ab4f8;font-size:14px}
        .title{font-weight:bold;font-size:18px;color:#8ab4f8;margin-bottom:6px;line-height:1.3}
        .snippet{color:#bdc1c6;font-size:14px;line-height:1.4}
        .loading{color:#8ab4f8;text-align:center;margin:40px 0;font-size:16px}
        .error{color:#f28b82;text-align:center;margin:40px 0;font-size:16px}
    </style>
</head>
<body>
    <!-- Navigation Bar (hidden on home) -->
    <div class="nav-bar" id="nav-bar">
        <div class="nav-controls">
            <button id="back-btn" class="nav-btn" onclick="browser.goBack()" disabled>←</button>
            <button id="forward-btn" class="nav-btn" onclick="browser.goForward()" disabled>→</button>
        </div>
        <div class="nav-logo">NULL</div>
        <div class="nav-search-container">
            <input type="text" id="nav-search-input" class="nav-search-input" placeholder="Search or type URL">
            <button id="nav-search-btn" class="nav-search-btn" onclick="browser.handleNavInput()">Go</button>
        </div>
    </div>

    <!-- Tab Bar (hidden on home) -->
    <div class="tab-bar" id="tab-bar">
        <div class="tabs" id="tabs-container">
            <div class="tab active" data-tab-id="tab-1">
                <span>Search Results</span>
                <button class="close-tab" onclick="browser.closeTab('tab-1')">×</button>
            </div>
        </div>
        <button id="new-tab-btn" class="new-tab-btn" onclick="browser.createNewTab()">+</button>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Home Page (only logo + search) -->
        <div id="home-page" class="tab-content active">
            <div class="home-page">
                <div class="home-logo">
                    N<span class="loader-container"><div class="u-bottom"></div><div class="u-top"></div><div class="diagonal-line"></div></span>LL
                </div>
                <div class="home-search-container">
                    <input type="text" id="home-search-input" class="home-search-input" placeholder="Search NULL or type a URL">
                    <button onclick="browser.performSearch()" class="home-search-btn">Search</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // NULL Browser + Bright Data Web-Unlocker
        class NullBrowser {
            constructor() {
                this.tabs = new Map();
                this.activeTabId = 'tab-1';
                this.tabCounter = 1;
                this.currentQuery = '';
                this.history = new Map(); // tabId → {past:[],future:[]}
                this.currentPage = 'home'; // 'home' or 'results'
                /*  ======  FILL THESE  ======  */
                this.bdZone   = 'web_unlocker1';        // ← zone name
                this.bdToken  = '9e171609-0e3f-4a64-91b8-7824e2707154'; // ← bearer
                // ====================================
                this.initializeEventListeners();
                this.initializeFirstTab();
            }

            initializeEventListeners() {
                document.getElementById('home-search-input').addEventListener('keypress', e=>{
                    if (e.key==='Enter') this.performSearch();
                });
                document.getElementById('nav-search-input').addEventListener('keypress', e=>{
                    if (e.key==='Enter') this.handleNavInput();
                });
                document.addEventListener('keydown', e=>{
                    if (e.ctrlKey||e.metaKey){
                        switch(e.key){
                            case 't': e.preventDefault(); this.createNewTab(); break;
                            case 'w': e.preventDefault(); this.closeTab(this.activeTabId); break;
                            case 'r': e.preventDefault(); this.reload(); break;
                        }
                    }
                });
            }

            initializeFirstTab() {
                this.tabs.set('tab-1', {type:'home',url:'null://home',title:'NULL'});
                this.history.set('tab-1', {past:[],future:[]});
            }

            showPage(page) {
                this.currentPage = page;
                const nav=document.getElementById('nav-bar'), tabBar=document.getElementById('tab-bar');
                if (page==='home') { nav.style.display='none'; tabBar.style.display='none'; }
                else { nav.style.display='flex'; tabBar.style.display='flex'; }
            }

            /* ----------  universal input:  search OR visit URL  ---------- */
            handleNavInput() {
                const raw = document.getElementById('nav-search-input').value.trim();
                if (!raw) return;
                // if it looks like a URL → visit; else → search
                const isUrl = /^https?:\/\//i.test(raw) || raw.includes('.') && !raw.includes(' ');
                if (isUrl) {
                    const url = /^https?:\/\//i.test(raw) ? raw : 'https://' + raw;
                    this.openInNewTab(url);
                } else {
                    this.showSearchResults(raw);
                }
            }

            performSearch() {
                const q=document.getElementById('home-search-input').value.trim();
                if (q) this.showSearchResults(q);
            }

            showSearchResults(query) {
                this.currentQuery=query; this.showPage('results');
                document.getElementById('nav-search-input').value=query;
                const contentArea=document.querySelector('.content-area');
                const pane=document.createElement('div');
                pane.className='tab-content active'; pane.id='content-tab-1';
                pane.innerHTML=`
                    <div class="results-page">
                        <div class="results-content">
                            <div id="stats" class="stats"></div>
                            <div id="results-list"><div class="loading">Searching …</div></div>
                        </div>
                    </div>`;
                contentArea.querySelector('.tab-content.active')?.classList.remove('active');
                const old=document.getElementById('content-tab-1');
                if (old) old.remove();
                contentArea.appendChild(pane);
                this.switchTab('tab-1');
                this.executeSearch(query);
            }

            executeSearch(query) {
                const resultsDiv=document.getElementById('results-list'), statsDiv=document.getElementById('stats');
                fetch(`http://localhost:8080/search?q=${encodeURIComponent(query)}&limit=20`)
                    .then(r=>{if(!r.ok) throw new Error('Network error'); return r.json();})
                    .then(data=>{
                        if(!data||data.length===0){
                            resultsDiv.innerHTML=`<div class="error">No results found for "${query}"</div>`;
                            statsDiv.innerHTML='No results found'; return;
                        }
                        statsDiv.innerHTML=`About ${data.length} results`;
                        resultsDiv.innerHTML=data.map(r=>{
                            const u=this.escapeHtml(r.url), t=this.escapeHtml(r.title||'No title'),
                                  s=this.escapeHtml(r.snippet||''), d=this.escapeHtml(r.domain||new URL(r.url).hostname);
                            return `
                                <div class="result-item" onclick="browser.openInNewTab('${u}')">
                                    <div class="result-header">${r.favicon_url?`<img src="${r.favicon_url}" class="favicon" onerror="this.style.display='none'">`:''}<span class="domain">${d}</span></div>
                                    <div class="title">${t}</div><div class="snippet">${s}</div>
                                </div>`;
                        }).join('');
                    })
                    .catch(err=>{
                        resultsDiv.innerHTML=`<div class="error">Failed to connect to search server.<br><br>Run: <code>cargo run --bin web_server</code></div>`;
                    });
            }

            /* ----------  open ANY page via Bright Data  ---------- */
            openInNewTab(url) {
                const tabId='tab-'+(++this.tabCounter);
                const host=new URL(url).hostname;

                // tab button
                const btn=document.createElement('div');
                btn.className='tab'; btn.dataset.tabId=tabId;
                btn.innerHTML=`<span>${host}</span><button class="close-tab" onclick="browser.closeTab('${tabId}')">×</button>`;
                btn.onclick=e=>{if(e.target.tagName!=='BUTTON') this.switchTab(tabId);};
                document.getElementById('tabs-container').appendChild(btn);

                // content pane – iframe src = local proxy → BD
                const proxyUrl=`http://localhost:3000/bd-proxy?url=${encodeURIComponent(url)}`;
                const pane=document.createElement('div');
                pane.className='tab-content'; pane.id='content-'+tabId;
                pane.innerHTML=`<iframe src="${proxyUrl}" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>`;
                document.querySelector('.content-area').appendChild(pane);

                this.tabs.set(tabId,{type:'page',url,title:host});
                this.history.set(tabId,{past:[],future:[]});
                this.switchTab(tabId);
                this.showPage('results');
            }

            switchTab(tabId){
                document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
                document.querySelector(`[data-tab-id="${tabId}"]`).classList.add('active');
                document.getElementById('content-'+tabId).classList.add('active');
                this.activeTabId=tabId;
                this.updateNavButtons();
            }
            closeTab(tabId){
                if(this.tabs.size<=1) return;
                document.querySelector(`[data-tab-id="${tabId}"]`).remove();
                document.getElementById('content-'+tabId).remove();
                this.tabs.delete(tabId); this.history.delete(tabId);
                const first=document.querySelector('.tab');
                if(first) this.switchTab(first.dataset.tabId);
            }

            /* ----------  BACK / FORWARD  (iframe history)  ---------- */
            goBack(){
                const iframe=document.getElementById('content-'+this.activeTabId)?.querySelector('iframe');
                if(iframe){iframe.contentWindow.history.back();}
            }
            goForward(){
                const iframe=document.getElementById('content-'+this.activeTabId)?.querySelector('iframe');
                if(iframe){iframe.contentWindow.history.forward();}
            }
            updateNavButtons(){
                // keep both enabled – iframe history not measurable
                document.getElementById('back-btn').disabled=false;
                document.getElementById('forward-btn').disabled=false;
            }

            /* ----------  utilities  ---------- */
            escapeHtml(text){
                const div=document.createElement('div');
                div.textContent=text;
                return div.innerHTML;
            }
            reload(){
                const iframe=document.getElementById('content-'+this.activeTabId)?.querySelector('iframe');
                if(iframe) iframe.src=iframe.src;
                else if(this.currentPage==='results') this.executeSearch(this.currentQuery);
            }
            createNewTab(){this.showHomePage();}
        }

        // ---------- init ----------
        let browser;
        document.addEventListener('DOMContentLoaded',()=>{
            browser=new NullBrowser();
            document.getElementById('home-search-input').focus();
        });
        window.browser={
            performSearch:()=>browser.performSearch(),
            openSearchResult:(url)=>browser.openInNewTab(url)
        };
    </script>
</body>
</html>
