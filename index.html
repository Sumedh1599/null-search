<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NULL Browser</title>
    <style>
        /* ---------- BROWSER LAYOUT ---------- */
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%;overflow:hidden}
        body{
            background:#000;
            color:#fff;
            font-family:Arial,Helvetica,sans-serif;
            display:flex;
            flex-direction:column;
            transition: all 0.3s ease;
        }

        body.light-mode {
            background: #fff;
            color: #333;
        }

        /* Theme Toggle Switch - REMOVED BUT KEPT FOR AI THEME CONTROL */
        /*
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #222;
            border: 1px solid #444;
            border-radius: 20px;
            padding: 8px 16px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .light-mode .theme-toggle {
            background: #f0f0f0;
            border-color: #ccc;
            color: #333;
        }
        */

        /* ---------- NAVIGATION BAR (hidden on home) ---------- */
        .nav-bar{
            display:flex;
            align-items:center;
            padding:8px 12px;
            background:#111;
            border-bottom:1px solid #222;
            gap:12px;
            display:none;
        }

        .light-mode .nav-bar {
            background: #f8f9fa;
            border-bottom: 1px solid #dadce0;
        }

        .nav-logo{
            font-size:25px;
            font-weight:bold;
            letter-spacing:-1px;
            margin:0 30px 0 12px;
            min-width: 80px;
        }

        .nav-search-container{
            display:flex;
            gap:10px;
            flex:1;
            align-items:center;
        }

        .nav-search-input{
            width: 800px;
            padding:12px 20px;
            border:1px solid #00ffff;
            border-radius:4px;
            font-size:14px;
            background:#000;
            color:#fff;
            outline:none;
            text-align:center;
            transition: all 0.3s ease;
        }

        .light-mode .nav-search-input {
            border: 1px solid #00ffff;
            background: #fff;
            color: #333;
        }

        .nav-search-input:focus{
            border-color:#00ffff;
            box-shadow: 0 0 10px #00ffff;
        }

        .nav-search-btn{
            padding:12px 24px;
            background:transparent;
            color:#00ffff;
            border:1px solid #00ffff;
            border-radius:4px;
            cursor:pointer;
            font-size:14px;
            font-weight:bold;
            transition: all 0.3s ease;
        }

        .light-mode .nav-search-btn {
            background: transparent;
            color: #00ffff;
            border: 1px solid #00ffff;
        }

        .nav-search-btn:hover{
            background:#00ffff;
            color:#000;
            box-shadow: 0 0 10px #00ffff;
        }

        .light-mode .nav-search-btn:hover{
            background:#00ffff;
            color:#000;
            box-shadow: 0 0 10px #00ffff;
        }

        /* ---------- CONTENT AREA ---------- */
        .content-area{
            flex:1;
            position:relative;
            overflow:hidden;
        }
        .tab-content{
            display:none;
            width:100%;
            height:100%;
            position:absolute;
            top:0;
            left:0;
        }
        .tab-content.active{
            display:block;
        }
        iframe{
            width:100%;
            height:100%;
            border:none;
            background:#fff;
        }

        /* ---------- HOME PAGE (only logo + search) ---------- */
        .home-page{
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            height:100%;
            background:#000;
            text-align:center;
        }

        .light-mode .home-page {
            background: #fff;
        }

        .home-logo{
            font-size:125px;
            font-weight:bold;
            letter-spacing:-1px;
            margin-bottom:30px;
            display:flex;
            align-items:center;
            gap:.04em;
            color: white;
        }

        .light-mode .home-logo {
            color: #333;
        }

        /* ---- U-to-0 loader ---- */
        .loader-container{position:relative;width:200px;height:200px;transform:scale(.625);transform-origin:center}
        .u-bottom{position:absolute;width:170px;height:100%;border:15px solid white;border-radius:0 0 85px 85px;border-top:none;box-sizing:border-box;left:15px}
        .light-mode .u-bottom { border-color: #333; }
        .u-top{position:absolute;width:232px;height:102%;border-top:15px solid white;border-radius:116px 116px 0 0;border-left:15px solid transparent;border-right:15px solid transparent;border-bottom:none;box-sizing:border-box;transform:rotate(180deg);left:-16px;top:-1px;animation:flipU 5s infinite}
        .light-mode .u-top { border-top-color: #333; border-left-color: transparent; border-right-color: transparent; }
        .diagonal-line{
            position:absolute;
            width:185px; /* Increased by 5px */
            height:15px;
            background-color:white;
            top:50%;
            left:45%; /* Adjusted to extend more from left */
            transform:translate(-50%,-50%) rotate(45deg);
            opacity:0;
            animation:lineAppear 5s infinite
        }
        .light-mode .diagonal-line { background-color: #333; }
        @keyframes flipU{0%,40%{transform:rotate(180deg) translateY(0);opacity:0}50%,90%{transform:rotate(0) translateY(-34px);opacity:1}100%{transform:rotate(180deg) translateY(0);opacity:0}}
        @keyframes lineAppear{0%,45%{opacity:0}50%,90%{opacity:1}95%,100%{opacity:0}}
        .home-search-container{display:flex;flex-direction:column;align-items:center;gap:12px}
        .home-search-input{
            width:900px;
            padding:12px 16px;
            border:1px solid #5f6368;
            border-radius:50px;
            background:#000;
            color:#fff;
            outline:none;
            font-size:16px;
            text-align:center
        }
        .light-mode .home-search-input { 
            background: #fff; 
            color: #333; 
            border: 1px solid #dfe1e5; /* Added grey border for light mode */
        }
        .home-search-input:focus{
            border-color:#8ab4f8;
            width:840px;
            transition:width .2s ease
        }
        .light-mode .home-search-input:focus {
            border-color: #1a73e8; /* Blue focus in light mode */
        }
        .home-search-btn{
            padding:10px 30px;
            background:#303134;
            color:#fff;
            border:none;
            border-radius:6px;
            cursor:pointer;
            font-size:14px
        }
        .light-mode .home-search-btn { 
            background: #f8f9fa; 
            color: #333; 
            border: 1px solid #dadce0; /* Added border for light mode */
        }
        .home-search-btn:hover{
            background:#3c4043
        }
        .light-mode .home-search-btn:hover{
            background:#e8eaed;
            border-color: #bdc1c6;
        }

        /* ---------- RESULTS PAGE (with PROPER scrollbar) ---------- */
        .results-page{
            background:#000;
            color:#fff;
            height:100%;
            width:100%;
            display:flex;
            justify-content:flex-end;
            overflow:hidden;
        }

        .light-mode .results-page {
            background: #fff;
            color: #333;
        }
        
        /* Scrollable results container */
        .results-scroll-container {
            width: 60%;
            max-width: 800px;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            scrollbar-width: thin;
            scrollbar-color: #444 #111;
        }

        .light-mode .results-scroll-container {
            scrollbar-color: #dadce0 #f8f9fa;
        }
        
        .results-scroll-container::-webkit-scrollbar {
            width: 12px;
        }
        
        .results-scroll-container::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }

        .light-mode .results-scroll-container::-webkit-scrollbar-track {
            background: #f8f9fa;
        }
        
        .results-scroll-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }

        .light-mode .results-scroll-container::-webkit-scrollbar-thumb {
            background: #dadce0;
            border: 2px solid #f8f9fa;
        }
        
        .results-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .light-mode .results-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #bdc1c6;
        }
        
        .stats{
            color:#9aa0a6;
            font-size:14px;
            margin-bottom:20px;
            padding:0 10px;
            text-align:right
        }

        .light-mode .stats {
            color: #70757a;
        }

        .result-item{
            background:#111;
            border-radius:8px;
            padding:20px;
            margin-bottom:16px;
            cursor:pointer;
            transition:background .2s;
            border:1px solid #222
        }

        .light-mode .result-item {
            background: #f8f9fa;
            border: 1px solid #dadce0;
        }

        .result-item:hover{
            background:#1a1a1a;
            border-color:#333
        }

        .light-mode .result-item:hover {
            background: #e8eaed;
            border-color: #bdc1c6;
        }

        .result-header{
            display:flex;
            align-items:center;
            margin-bottom:8px
        }
        .favicon{
            width:16px;
            height:16px;
            margin-right:8px;
            border-radius:2px
        }
        .domain{
            color:#8ab4f8;
            font-size:14px
        }

        .light-mode .domain {
            color: #1a73e8;
        }

        .title{
            font-weight:bold;
            font-size:18px;
            color:#8ab4f8;
            margin-bottom:6px;
            line-height:1.3;
            text-align:left
        }

        .light-mode .title {
            color: #1a0dab;
        }

        .snippet{
            color:#bdc1c6;
            font-size:14px;
            line-height:1.4;
            text-align:left
        }

        .light-mode .snippet {
            color: #4d5156;
        }

        .loading{
            color:#8ab4f8;
            text-align:center;
            margin:40px 0;
            font-size:16px
        }

        .light-mode .loading {
            color: #1a73e8;
        }

        .error{
            color:#f28b82;
            text-align:center;
            margin:40px 0;
            font-size:16px
        }

        .light-mode .error {
            color: #d93025;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button - REMOVED BUT AVAILABLE FOR AI THEME CONTROL -->
    <!--
    <button class="theme-toggle" onclick="browser.toggleTheme()">üåô Dark Mode</button>
    -->

    <!-- Navigation Bar (hidden on home) -->
    <div class="nav-bar" id="nav-bar">
        <div class="nav-logo">NULL</div>
        <div class="nav-search-container">
            <input type="text" id="nav-search-input" class="nav-search-input" placeholder="Search or type URL">
            <button id="nav-search-btn" class="nav-search-btn" onclick="browser.handleNavInput()">Search</button>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Home Page (only logo + search) -->
        <div id="home-page" class="tab-content active">
            <div class="home-page">
                <div class="home-logo">
                    N<span class="loader-container"><div class="u-bottom"></div><div class="u-top"></div><div class="diagonal-line"></div></span>LL
                </div>
                <div class="home-search-container">
                    <input type="text" id="home-search-input" class="home-search-input" placeholder="Search NULL or type a URL">
                    <button onclick="browser.performSearch()" class="home-search-btn">Search</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // NULL Browser + Bright Data Web-Unlocker

        class NullBrowser {
            constructor() {
                this.tabs = new Map();
                this.activeTabId = 'tab-1';
                this.tabCounter = 1;
                this.currentQuery = '';
                this.history = new Map(); // tabId ‚Üí {past:[],future:[]}
                this.currentPage = 'home'; // 'home' or 'results'
                this.isLightMode = false;

                /*  ======  FILL THESE  ======  */
                this.bdZone   = 'web_unlocker1';        // ‚Üê zone name
                this.bdToken  = '9e171609-0e3f-4a64-91b8-7824e2707154'; // ‚Üê bearer
                // ====================================
                this.initializeEventListeners();
                this.initializeFirstTab();
                this.initializeThemeListener();
            }

            initializeEventListeners() {
                document.getElementById('home-search-input').addEventListener('keypress', e=>{
                    if (e.key==='Enter') this.performSearch();
                });
                document.getElementById('nav-search-input').addEventListener('keypress', e=>{
                    if (e.key==='Enter') this.handleNavInput();
                });
            }

            initializeFirstTab() {
                this.tabs.set('tab-1', {type:'home',url:'null://home',title:'NULL'});
                this.history.set('tab-1', {past:[],future:[]});
            }

            /* ---------- THEME LISTENER FOR CHROMIUM SIDEBAR TOGGLE ---------- */
            initializeThemeListener() {
                // Listen for theme change messages from Chromium
                // This will be called by Chromium when sidebar toggle is clicked
                window.addEventListener('message', (event) => {
                    // Only accept messages from same origin for security
                    if (event.data && event.data.type === 'NULL_THEME_CHANGE') {
                        const isLight = event.data.isLightMode;
                        this.setTheme(isLight);
                    }
                });

                // Also listen for direct function calls from Chromium's injected script
                window.setNullTheme = (isLightMode) => {
                    this.setTheme(isLightMode);
                };
                
                // Request initial theme from Chromium on page load
                // Chromium will inject the theme when page loads
                // For now, default to dark mode, Chromium will sync it
            }

            setTheme(isLightMode) {
                this.isLightMode = isLightMode;
                document.body.classList.toggle('light-mode', isLightMode);
            }

            showPage(page) {
                this.currentPage = page;
                const nav=document.getElementById('nav-bar');
                if (page==='home') { 
                    nav.style.display='none'; 
                } else { 
                    nav.style.display='flex'; 
                }
            }

            /* ---------- THEME TOGGLE ---------- */
            /* REMOVED BUT AVAILABLE FOR AI THEME CONTROL
            toggleTheme() {
                this.isLightMode = !this.isLightMode;
                document.body.classList.toggle('light-mode', this.isLightMode);
                const toggleBtn = document.querySelector('.theme-toggle');
                toggleBtn.textContent = this.isLightMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
            }
            */

            /* ----------  universal input:  search OR visit URL  ---------- */
            handleNavInput() {
                const raw = document.getElementById('nav-search-input').value.trim();
                if (!raw) return;

                // if it looks like a URL ‚Üí visit; else ‚Üí search
                const isUrl = /^https?:\/\//i.test(raw) || raw.includes('.') && !raw.includes(' ');
                if (isUrl) {
                    const url = /^https?:\/\//i.test(raw) ? raw : 'https://' + raw;
                    this.openInNewTab(url);
                } else {
                    this.showSearchResults(raw);
                }
            }

            performSearch() {
                const q=document.getElementById('home-search-input').value.trim();
                if (q) this.showSearchResults(q);
            }

            showSearchResults(query) {
                this.currentQuery=query; this.showPage('results');
                document.getElementById('nav-search-input').value=query;
                const contentArea=document.querySelector('.content-area');
                const pane=document.createElement('div');
                pane.className='tab-content active'; pane.id='content-tab-1';
                pane.innerHTML=`
                    <div class="results-page">
                        <div class="results-scroll-container">
                            <div id="stats" class="stats"></div>
                            <div id="results-list"><div class="loading">Searching ‚Ä¶</div></div>
                        </div>
                    </div>`;
                contentArea.querySelector('.tab-content.active')?.classList.remove('active');
                const old=document.getElementById('content-tab-1');
                if (old) old.remove();
                contentArea.appendChild(pane);
                this.switchTab('tab-1');
                this.executeSearch(query);
            }

            executeSearch(query) {
                const resultsDiv=document.getElementById('results-list'), statsDiv=document.getElementById('stats');
                
                fetch(`http://localhost:8080/search?q=${encodeURIComponent(query)}&limit=20`)
                    .then(r=>{if(!r.ok) throw new Error('Network error'); return r.json();})
                    .then(data=>{
                        if(!data||data.length===0){
                            resultsDiv.innerHTML=`<div class="error">No results found for "${query}"</div>`;
                            statsDiv.innerHTML='No results found'; return;
                        }
                        statsDiv.innerHTML=`About ${data.length} results`;
                        resultsDiv.innerHTML=data.map(r=>{
                            const u=this.escapeHtml(r.url), t=this.escapeHtml(r.title||'No title'),
                                  s=this.escapeHtml(r.snippet||''), d=this.escapeHtml(r.domain||new URL(r.url).hostname);
                            return `
                                <div class="result-item" onclick="browser.openInNewTab('${u}')">
                                    <div class="result-header">${r.favicon_url?`<img src="${r.favicon_url}" class="favicon" onerror="this.style.display='none'">`:''}<span class="domain">${d}</span></div>
                                    <div class="title">${t}</div><div class="snippet">${s}</div>
                                </div>`;
                        }).join('');
                    })
                    .catch(err=>{
                        resultsDiv.innerHTML=`<div class="error">Failed to connect to search server.<br><br>Run: <code>cargo run --bin web_server</code></div>`;
                    });
            }

            /* ----------  open ANY page via Bright Data  ---------- */
            openInNewTab(url) {
                const tabId='tab-'+(++this.tabCounter);
                const host=new URL(url).hostname;

                // content pane ‚Äì iframe src = local proxy ‚Üí BD
                const proxyUrl=`http://localhost:3000/bd-proxy?url=${encodeURIComponent(url)}`;
                const pane=document.createElement('div');
                pane.className='tab-content'; pane.id='content-'+tabId;
                pane.innerHTML=`<iframe src="${proxyUrl}" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>`;
                document.querySelector('.content-area').appendChild(pane);

                this.tabs.set(tabId,{type:'page',url,title:host});
                this.history.set(tabId,{past:[],future:[]});
                this.switchTab(tabId);
                this.showPage('results');
            }

            switchTab(tabId){
                document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
                document.getElementById('content-'+tabId).classList.add('active');
                this.activeTabId=tabId;
            }

            closeTab(tabId){
                if(this.tabs.size<=1) return;
                document.getElementById('content-'+tabId).remove();
                this.tabs.delete(tabId); this.history.delete(tabId);
                const firstTab = this.tabs.keys().next().value;
                if(firstTab) this.switchTab(firstTab);
            }

            /* ----------  utilities  ---------- */
            escapeHtml(text){
                const div=document.createElement('div');
                div.textContent=text;
                return div.innerHTML;
            }
            reload(){
                const iframe=document.getElementById('content-'+this.activeTabId)?.querySelector('iframe');
                if(iframe) iframe.src=iframe.src;
                else if(this.currentPage==='results') this.executeSearch(this.currentQuery);
            }
            createNewTab(){this.showHomePage();}
        }

        // ---------- init ----------
        let browser;
        document.addEventListener('DOMContentLoaded',()=>{
            browser=new NullBrowser();
            document.getElementById('home-search-input').focus();
        });
        window.browser={
            performSearch:()=>browser.performSearch(),
            openSearchResult:(url)=>browser.openInNewTab(url),
            // toggleTheme:()=>browser.toggleTheme() // REMOVED BUT AVAILABLE FOR AI THEME CONTROL
        };
    </script>
</body>
</html>
